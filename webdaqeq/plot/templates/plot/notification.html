<!DOCTYPE html>
<html lang="es">
  {% extends 'plot/home.html' %}
  {% load bootstrap3 %}
  {% load staticfiles %}

  {% block meta %}
    <meta charset="utf-8">
    <script src="{% static "plot/js/jquery-1.12.3.min.js" %}"></script>
    <script src="{% static "plot/js/validations.js" %}"></script>
    <script src="{% static "plot/js/djangoAjax.js" %}"></script>
    <script type="text/javascript">

      var sensorNums = [];
      function addSerial(){
        var serialNum = $("[name='new_sensor']")[0].value;
        $.ajax({
          url: '/plot/sensors/',
          type: "POST",
          async: false,
          data: { 'command' : 'add', 'serial' : serialNum },
          dataType: 'json',
          success: function (response) {
            //  $("sensor_table").addElement(serialNum);
            console.log(0)
            switch(response[0]){
              case "duplicated":
                window.alert("No puede haber seriales duplicadas");
                break;
              case "k":
                break;
              default:
                $("#sensor_table").append(newSensorRow(response));
                sensorNums.push(response[0]);
                break;
              }
            }
        });
      }

      function refreshSerial(){
        $.ajax({
          url: '/plot/sensors/',
          type: "POST",
          async: false,
          data: { 'command' : 'refresh' },
          dataType: 'json',
          success: function (response) {
            //  $("sensor_table").addElement(serialNum);
            var auxSensorNums = [];
            $("#sensor_table").html('<tr>' +
                '<th class="col-xs-1">N° de serie</th>' +
                '<th class="col-xs-1">Posición</th>' +
                '<th class="col-xs-1">Detrend</th>' +
                '<th class="col-xs-3">Trigger(x,y,z):</th>' +
                '<th class="col-xs-3">Detrigger(x,y,z):</th>' +
                '<th class="col-xs-3">Votos:</th>' +
                '<th class="col-xs-1">Trigger máximo(x,y,z):</th>' +
              '</tr>' +
              '<tr>' +
                '<td class="col-xs-1">' +
                '<td class="col-xs-1">' +
                '<td class="col-xs-1">' +
                '<td class="col-xs-3">' +
                  '<input type="number" id="id_triggerXYZ" name="triggerXYZ" min=0.01 step=0.001 value=0.01>' +
                  '<input type="button" id="id_setTrigger" name="setTrigger" value="Set" onclick="triggerSet()">' +
                '<td class="col-xs-3">' +
                  '<input type="number" id="id_detriggerXYZ" name="detriggerXYZ" min=0.01 step=0.001 value=0.01>' +
                  '<input type="button" id="id_setDetrigger" name="setDetrigger" value="Set" onclick="detriggerSet()">' +
                '<td class="col-xs-2">' +
                  '<input type="number" id="id_votesXYZ" name="votesXYZ" min=0 value=1>' +
                  '<input type="button" id="id_setVotes" name="setVotes" value="Set" onclick="votesSet()">' +
                '<td class="col-xs-1">' +
                  '<input type="number" id="id_secondTriggerXYZ" name="secondTriggerXYZ" min=0.01 step=0.001 value=0.01>' +
                  '<input type="button" id="id_setSecondTrigger" name="setSecondTrigger" value="Set" onclick="secondTriggerSet()">' +
              '</tr>');
            $.each(response, function(i, value){
                console.log(value[0]);
                if(jQuery.inArray(value[0],sensorNums) == -1){
                };
                $("#sensor_table").append(newSensorRow(value));
                auxSensorNums.push(value[0]);
            });
            sensorNums = auxSensorNums;
          }
        });
      }

      function triggerSet(){
        var r = $("#id_triggerXYZ").val();
        $("[class='trigger-input']").each(function(i, e){
          e.value = r;
        });
      }

      function detriggerSet(){
        var r = $("#id_detriggerXYZ").val();
        $("[class='detrigger-input']").each(function(i, e){
          e.value = r;
        });
      }

      function votesSet(){
        var r = $("#id_votesXYZ").val();
        $("[class='votes-input']").each(function(i, e){
          e.value = r;
        });
      }

      function secondTriggerSet(){
        var r = $("#id_secondTriggerXYZ").val();
        $("[class='secondtrigger-input']").each(function(i, e){
          e.value = r;
        });
      }

      function newSensorRow(value){
        if (value[15] == "1"){
          if (value[16] == "0"){
            return '<tr>' +
              '<input type="hidden" name="isRed'+value[0]+' "value="false">' +
              '<td class="col-xs-1">' +
                '<label class="checkbox-inline">' +
                '<input type="checkbox" checked="checked" name="check' + value[0] + '">' +
                '<input type="text" name="serialNum" readonly="true" value="' + value[0] + '">' +
              '<td class="col-xs-1">' +
                '<input type="text" name="position" required value="' + value[1] + '">' +
              '<td class="col-xs-1">' +
                '<input type="number" min=0 name="detrend" value=' + value[8] + '>' +
              '<td class="col-xs-3">' +
                '<input type="number" class="trigger-input" name="triggerX" min=0.01 step=0.001 value=' + value[2] + '>' +
                '<input type="number" class="trigger-input" name="triggerY" min=0.01 step=0.001 value=' + value[3] + '>' +
                '<input type="number" class="trigger-input" name="triggerZ" min=0.01 step=0.001 value=' + value[4] + '>' +
              '<td class="col-xs-3">' +
                '<input type="number" class="detrigger-input" name="detriggerX" min=0.01 step=0.001 value=' + value[5] + '>' +
                '<input type="number" class="detrigger-input" name="detriggerY" min=0.01 step=0.001 value=' + value[6] + '>' +
                '<input type="number" class="detrigger-input" name="detriggerZ" min=0.01 step=0.001 value=' + value[7] + '>' +
              '<td class="col-xs-2">' +
                '<input type="number" class="votes-input" name="votesX" min=0 value=' + value[9] + '>' +
                '<input type="number" class="votes-input" name="votesY" min=0 value=' + value[10] + '>' +
                '<input type="number" class="votes-input" name="votesZ" min=0 value=' + value[11] + '>' +
              '<td class="col-xs-1">' +
                  '<input type="number" class="secondtrigger-input" name="secondTriggerX" min=0.01 step=0.001 value=' + value[12] + '>' +
                  '<input type="number" class="secondtrigger-input" name="secondTriggerY" min=0.01 step=0.001 value=' + value[13] + '>' +
                  '<input type="number" class="secondtrigger-input" name="secondTriggerZ" min=0.01 step=0.001 value=' + value[14] + '>' +
            '</tr>';
          }
          else{
            return '<tr>' +
              '<input type="hidden" name="isRed'+value[0]+' "value="true">' +
              '<td class="col-xs-1">'+
                '<label class="checkbox-inline">' +
                '<input type="checkbox" checked="checked" name="check' + value[0] + '">' +
                '<input type="text" class="text-danger" name="serialNum" readonly="true" value="' + value[0] + '">' +
              '<td class="col-xs-1"><input type="text" class="text-danger" name="position" required value="' + value[1] + '">' +
              '<td class="col-xs-1"><input type="number" min=0 name="detrend" value=' + value[8] + '>' +
              '<td class="col-xs-3">' +
                '<input type="number" class="trigger-input" name="triggerX" min=0.01 step=0.001 value=' + value[2] + '>' +
                '<input type="number" class="trigger-input" name="triggerY" min=0.01 step=0.001 value=' + value[3] + '>' +
                '<input type="number" class="trigger-input" name="triggerZ" min=0.01 step=0.001 value=' + value[4] + '>' +
              '<td class="col-xs-3">' +
                '<input type="number" class="detrigger-input" name="detriggerX" min=0.01 step=0.001 value=' + value[5] + '>' +
                '<input type="number" class="detrigger-input" name="detriggerY" min=0.01 step=0.001 value=' + value[6] + '>' +
                '<input type="number" class="detrigger-input" name="detriggerZ" min=0.01 step=0.001 value=' + value[7] + '>' +
              '<td class="col-xs-2">' +
                '<input type="number" class="votes-input" name="votesX" min=0 value=' + value[9] + '>' +
                '<input type="number" class="votes-input" name="votesY" min=0 value=' + value[10] + '>' +
                '<input type="number" class="votes-input" name="votesZ" min=0 value=' + value[11] + '>' +
              '<td class="col-xs-1">' +
                  '<input type="number" class="secondtrigger-input" name="secondTriggerX" min=0.01 step=0.001 value=' + value[12] + '>' +
                  '<input type="number" class="secondtrigger-input" name="secondTriggerY" min=0.01 step=0.001 value=' + value[13] + '>' +
                  '<input type="number" class="secondtrigger-input" name="secondTriggerZ" min=0.01 step=0.001 value=' + value[14] + '>' +
            '</tr>';
          }
        }
        else{
          if (value[15] == "0"){
            return '<tr>' +
            '<input type="hidden" name="isRed'+value[0]+' "value="false">' +
            '<td class="col-xs-1"><label class="checkbox-inline">' +
              '<input type="checkbox" name="check' + value[0] + '">' +
              '<input type="text" name="serialNum" readonly="true" value="' + value[0] + '">' +
            '<td class="col-xs-1"><input type="text" name="position" required value="' + value[1] + '">' +
            '<td class="col-xs-1"><input type="number" min=0 name="detrend" value=' + value[8] + '>' +
            '<td class="col-xs-3">' +
              '<input type="number" class="trigger-input" name="triggerX" min=0.01 step=0.001 value=' + value[2] + '>' +
              '<input type="number" class="trigger-input" name="triggerY" min=0.01 step=0.001 value=' + value[3] + '>' +
              '<input type="number" class="trigger-input" name="triggerZ" min=0.01 step=0.001 value=' + value[4] + '>' +
            '<td class="col-xs-3">' +
              '<input type="number" class="detrigger-input" name="detriggerX" min=0.01 step=0.001 value=' + value[5] + '>' +
              '<input type="number" class="detrigger-input" name="detriggerY" min=0.01 step=0.001 value=' + value[6] + '>' +
              '<input type="number" class="detrigger-input" name="detriggerZ" min=0.01 step=0.001 value=' + value[7] + '>' +
            '<td class="col-xs-2">' +
              '<input type="number" class="votes-input" name="votesX" min=0 value=' + value[9] + '>' +
              '<input type="number" class="votes-input" name="votesY" min=0 value=' + value[10] + '>' +
              '<input type="number" class="votes-input" name="votesZ" min=0 value=' + value[11] + '>' +
            '<td class="col-xs-1">' +
              '<input type="number" class="secondtrigger-input" name="secondTriggerX" min=0.01 step=0.001 value=' + value[12] + '>' +
              '<input type="number" class="secondtrigger-input" name="secondTriggerY" min=0.01 step=0.001 value=' + value[13] + '>' +
              '<input type="number" class="secondtrigger-input" name="secondTriggerZ" min=0.01 step=0.001 value=' + value[14] + '>' +
          '</tr>';
          }
          else{
            return "";
          }
        }
      }

  </script>
  <style type="text/css">

    .icon-input-btn{

        display: inline-block;
        position: relative;
    }

    .icon-input-btn .glyphicon{

        display: inline-block;
        position: absolute;
        left: 0.35em;
        top: 30%;
    }
    </style>
  {% endblock %}

  {% block title %}
    {{page_title}}
  {% endblock %}

  {% block content %}
  {% if user.is_authenticated %}
    {% if action_text == "Reiniciar" %}
    <form role="form" id="config_form" action="/plot/verify/" name="config" method="post" enctype="multipart/form-data" class="form-horizontal col-md-12">
      <div class="row">
        <div class="form-group col-sm-5">
          {% csrf_token %}
          {% bootstrap_form form layout='horizontal' %}
          <div class="form-group">
            <label class="col-md-3 control-label" for="id_enableSecondTrigger">&#160;</label>
            <div class="col-md-9">
              <div class="checkbox">
                <label for="id_enableSecondTrigger">
                  <input id="id_enableSecondTrigger" name="enableSecondTrigger" {% if secondTrigger %}checked="checked"{% endif %} type="checkbox" onchange="secondTrigger()"/> Habilitar segundo trigger
                </label>
              </div>
            </div>
          </div>
        </div>

        <div class="col-xs-5 col-xs-offset-1">
          {% if this_url == "/plot/config/" %}
          <h4>Sensores detectados</h4>
          <div class="col-xs-12">
            <table id="sensor_table" class="table-condensed">
              <tr>
                <th class="col-xs-1">N° de serie</th>
                <th class="col-xs-1">Posición</th>
                <th class="col-xs-1">Detrend</th>
                <th class="col-xs-3">Trigger(x,y,z):</th>
                <th class="col-xs-3">Detrigger(x,y,z):</th>
                <th class="col-xs-2">Votos:</th>
                <th class="col-xs-1">Trigger máximo(x,y,z):</th>
              </tr>
              <tr>
                <td class="col-xs-1">
                <td class="col-xs-1">
                <td class="col-xs-1">
                <td class="col-xs-3">
                  <input type="number" id="id_triggerXYZ" name="triggerXYZ" min=0.01 step=0.001 value=0.01>
                  <input type="button" id="id_setTrigger" name="setTrigger" value="Set" onclick="triggerSet()">
                <td class="col-xs-3">
                  <input type="number" id="id_detriggerXYZ" name="detriggerXYZ" min=0.01 step=0.001 value=0.01>
                  <input type="button" id="id_setDetrigger" name="setDetrigger" value="Set" onclick="detriggerSet()">
                <td class="col-xs-2">
                  <input type="number" id="id_votesXYZ" name="votesXYZ" min=0 value=1>
                  <input type="button" id="id_setVotes" name="setVotes" value="Set" onclick="votesSet()">
                <td class="col-xs-1">
                    <input type="number" id="id_secondTriggerXYZ" name="secondTriggerXYZ" min=0.01 step=0.001 value=0.01>
                    <input type="button" id="id_setSecondTrigger" name="setSecondTrigger" value="Set" onclick="secondTriggerSet()">
              </tr>
            {% for sensor in sensors %}
              <script>
                sensorNums.push('{{sensor.0}}')
              </script>
              <tr>
                <input type="hidden" name="isRed{{sensor.0}}" value={% if sensor.16 == "1" %}"true"{% else %}"false"{% endif %}>
                <td class="col-xs-1"><label class="checkbox-inline"><input type="checkbox" name="check{{sensor.0}}" {% if sensor.15 == "1" %}checked="checked"{% endif %}><input type="text" name="serialNum" {% if sensor.16 == "1" %}class="text-danger"{% endif %} readonly="true" value="{{sensor.0}}">
                <td class="col-xs-1"><input type="text" {% if sensor.16 == "1" %}class="text-danger"{% endif %} name="position" required value="{{sensor.1}}">
                <td class="col-xs-1"><input type="number" min=0 name="detrend" value={{sensor.8}}>
                <td class="col-xs-3">
                  <input type="number" class="trigger-input" name="triggerX" min=0.01 step=0.001 value={{sensor.2}}>
                  <input type="number" class="trigger-input" name="triggerY" min=0.01 step=0.001 value={{sensor.3}}>
                  <input type="number" class="trigger-input" name="triggerZ" min=0.01 step=0.001 value={{sensor.4}}>
                <td class="col-xs-3">
                  <input type="number" class="detrigger-input" name="detriggerX" min=0.01 step=0.001 value={{sensor.5}}>
                  <input type="number" class="detrigger-input" name="detriggerY" min=0.01 step=0.001 value={{sensor.6}}>
                  <input type="number" class="detrigger-input" name="detriggerZ" min=0.01 step=0.001 value={{sensor.7}}>
                <td class="col-xs-2">
                  <input type="number" class="votes-input" name="votesX" min=0 value={{sensor.9}}>
                  <input type="number" class="votes-input" name="votesY" min=0 value={{sensor.10}}>
                  <input type="number" class="votes-input" name="votesZ" min=0 value={{sensor.11}}>

                <td class="col-xs-1">
                  <input type="number" class="secondtrigger-input" name="secondTriggerX" min=0.01 step=0.001 value={{sensor.12}}>
                  <input type="number" class="secondtrigger-input" name="secondTriggerY" min=0.01 step=0.001 value={{sensor.13}}>
                  <input type="number" class="secondtrigger-input" name="secondTriggerZ" min=0.01 step=0.001 value={{sensor.14}}>
              </tr>

            {% endfor %}
            </table>
          </div>
          <div>
            <h4>Agregar Manualmente</h4>
            <input type="text" name="new_sensor">
            <input type="button" value="Agregar serie" onclick="addSerial()">
            <span class="icon-input-btn"><span class="glyphicon glyphicon-refresh inline"></span><input type="button" onclick="refreshSerial()"></span>
          </div>
          {% endif %}
        </div>
      </div>
      <input class="btn btn-primary col-md-1" name="action" type="submit" value="{{action_text}}">
      <input class="btn btn-success col-md-1" name="action" type="button" value="Trigger">
      {% buttons reset="Cancelar" layout='vertical' %}{% endbuttons %}
      <input type="hidden" name="this_url" value="{{this_url}}">
    </form>
    {% else %}
      <p>Para hacer cambios, debe detener la aplicación primero.</p>
      <form role="form" method="post" action="/plot/signal/">
        {% csrf_token %}
        <div class="row">
          <input class="btn btn-primary col-md-1" name="action" type="submit" value="{{action_text}}">
          <input class="btn btn-success col-md-1" name="action" type="button" value="Trigger">
          {% buttons reset="Cancelar" layout='vertical' %}{% endbuttons %}
          <input type="hidden" name="this_url" value="{{this_url}}">
        </div>
      </form>
    {% endif %}
  {% else %}
    <form method="post" action="{% url 'login' %}">
      {% csrf_token %}
      <table>
      <tr>
          <td>Nombre de usuario</td>
          <td><input type="text" name="username"></td>
      </tr>
      <tr>
          <td>Contraseña</td>
          <td><input type="password" name="password"></td>
      </tr>
      </table>

      <input type="submit" value="Login" />
      <input type="hidden" name="next" value="{{this_url}}" />
      <input class="col-md-12" type="hidden" name="this_url" value="{{this_url}}">
    </form>
  {% endif %}
{% endblock %}
</html>
